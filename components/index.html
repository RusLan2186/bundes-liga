{% extends 'layouts/base.html' %}

{% block title %}{{ t('home.title', '–ì–ª–∞–≤–Ω–∞—è') }} - {{ parent() }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Hero —Å–µ–∫—Ü–∏—è -->
    <section class="hero">
        <div class="hero-content">
            <h2>{{ t('home.welcome', '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à—É –±–∏–±–ª–∏–æ—Ç–µ–∫—É!') }}</h2>
            <p>{{ t('home.description', '–û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –º–∏—Ä –∑–Ω–∞–Ω–∏–π —Å –Ω–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π –∏–∑ —Ç—ã—Å—è—á –∫–Ω–∏–≥ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∂–∞–Ω—Ä–æ–≤.') }}</p>
            <a href="{{ absolute_url_lang('/catalog') }}" class="btn btn-primary">{{ t('home.browse', '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞—Ç–∞–ª–æ–≥') }}</a>
        </div>
        <div class="hero-image">
            <img src="/images/library-hero.jpg" alt="{{ t('home.hero_alt', '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞') }}">
        </div>
    </section>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <section class="stats">
        <div class="stats-grid">
            <div class="stat-item">
                <h3>{{ db('1753024126366')->countItems('books') | number }}</h3>
                <p>{{ t('stats.books', '–ö–Ω–∏–≥ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ') }}</p>
            </div>
            <div class="stat-item">
                <h3>{{ db('1753024126366')->countItems('genres') | number }}</h3>
                <p>{{ t('stats.genres', '–ñ–∞–Ω—Ä–æ–≤') }}</p>
            </div>
            <div class="stat-item">
                <h3>{{ db('1753024126366')->countItems('books', {'rating': '>8'}) | number }}</h3>
                <p>{{ t('stats.top_rated', '–ö–Ω–∏–≥ —Å –≤—ã—Å–æ–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º') }}</p>
            </div>
        </div>
    </section>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ -->
    <section class="latest-books">
        <h2>{{ t('home.latest_books', '–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è') }}</h2>
        
        {% set latestBooks = db('1753024126366')
            ->cache('latest_books', 1800)
            ->query('
                SELECT b.*, g.name as genre_name 
                FROM books b 
                LEFT JOIN genres g ON b.genre_id = g.id 
                ORDER BY b.created_at DESC 
                LIMIT 6
            ') %}

        {% if latestBooks %}
            <div class="books-grid">
                {% foreach latestBooks as book %}
                    <div class="book-card">
                        <div class="book-cover">
                            <img src="{{ book.cover_image ? '/images/' ~ book.cover_image : '/images/no-cover.jpg' }}" 
                                 alt="{{ book.title }}">
                            <div class="book-overlay">
                                <a href="{{ absolute_url_lang('/book/' ~ book.id) }}" class="btn btn-sm">{{ t('books.details', '–ü–æ–¥—Ä–æ–±–Ω–µ–µ') }}</a>
                            </div>
                        </div>
                        <div class="book-info">
                            <h3><a href="{{ absolute_url_lang('/book/' ~ book.id) }}">{{ translate(book.title, 'ru', locale) }}</a></h3>
                            <p class="author">{{ translate(book.author, 'ru', locale) }}</p>
                            <p class="genre">{{ translate(book.genre_name, 'ru', locale) }}</p>
                            {% if book.rating %}
                                <div class="rating">
                                    <span class="stars">
                                        {% for i in 1..5 %}
                                            <span class="{{ (book.rating / 2) >= i ? 'star filled' : 'star' }}">‚òÖ</span>
                                        {% endfor %}
                                    </span>
                                    <span class="rating-value">{{ book.rating | number(1) }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endforeach %}
            </div>
            
            <div class="section-footer">
                <a href="{{ absolute_url_lang('/catalog') }}" class="btn btn-outline">{{ t('home.view_all', '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∫–Ω–∏–≥–∏') }}</a>
            </div>
        {% endif %}
    </section>

    <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∂–∞–Ω—Ä—ã -->
    <section class="popular-genres">
        <h2>{{ t('home.popular_genres', '–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∂–∞–Ω—Ä—ã') }}</h2>
        
        {% set popularGenres = db('1753024126366')
            ->cache('popular_genres', 3600)
            ->query('
                SELECT g.*, COUNT(b.id) as book_count
                FROM genres g
                LEFT JOIN books b ON g.id = b.genre_id
                GROUP BY g.id
                HAVING book_count > 0
                ORDER BY book_count DESC
                LIMIT 8
            ') %}

        {% if popularGenres %}
            <div class="genres-grid">
                {% foreach popularGenres as genre %}
                    <div class="genre-card">
                        <a href="{{ absolute_url_lang('/catalog') }}?genre={{ genre.id }}">
                            <div class="genre-icon">
                                {% switch genre.name %}
                                    {% case '–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞' %}üöÄ
                                    {% case '–î–µ—Ç–µ–∫—Ç–∏–≤' %}üîç
                                    {% case '–†–æ–º–∞–Ω' %}üíï
                                    {% case '–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è' %}‚õµ
                                    {% case '–ù–∞—É—á–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞' %}üî¨
                                    {% default %}üìñ
                                {% endswitch %}
                            </div>
                            <h3>{{ translate(genre.name, 'ru', locale) }}</h3>
                            <p class="book-count">{{ t('genres.books_count', '%count% –∫–Ω–∏–≥', {'count': genre.book_count}) }}</p>
                        </a>
                    </div>
                {% endforeach %}
            </div>
        {% endif %}
    </section>

    <!-- –õ—É—á—à–∏–µ –∫–Ω–∏–≥–∏ -->
    <section class="top-rated">
        <h2>{{ t('home.top_rated', '–õ—É—á—à–∏–µ –∫–Ω–∏–≥–∏') }}</h2>
        
        {% set topBooks = db('1753024126366')
            ->cache('top_books', 3600)
            ->query('
                SELECT b.*, g.name as genre_name
                FROM books b
                LEFT JOIN genres g ON b.genre_id = g.id
                WHERE b.rating >= 8
                ORDER BY b.rating DESC
                LIMIT 4
            ') %}

        {% if topBooks %}
            <div class="books-list">
                {% foreach topBooks as book %}
                    <div class="book-item-horizontal">
                        <div class="book-cover-small">
                            <img src="{{ book.cover_image ? '/images/' ~ book.cover_image : '/images/no-cover.jpg' }}" 
                                 alt="{{ book.title }}">
                        </div>
                        <div class="book-details">
                            <h3><a href="{{ absolute_url_lang('/book/' ~ book.id) }}">{{ translate(book.title, 'ru', locale) }}</a></h3>
                            <p class="author">{{ translate(book.author, 'ru', locale) }}</p>
                            <p class="genre">{{ translate(book.genre_name, 'ru', locale) }}</p>
                            <p class="description">{{ translate(book.description, 'ru', locale) | truncate(150) }}</p>
                            <div class="rating">
                                <span class="stars">
                                    {% for i in 1..5 %}
                                        <span class="{{ (book.rating / 2) >= i ? 'star filled' : 'star' }}">‚òÖ</span>
                                    {% endfor %}
                                </span>
                                <span class="rating-value">{{ book.rating | number(1) }}/10</span>
                            </div>
                        </div>
                    </div>
                {% endforeach %}
            </div>
        {% endif %}
    </section>
</div>
{% endblock %}






